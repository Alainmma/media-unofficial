From 092e7fc319da2675b9328ee2553fce52085d62e2 Mon Sep 17 00:00:00 2001
From: Christoph Reiter <reiter.christoph@gmail.com>
Date: Wed, 15 Apr 2015 23:13:19 +0200
Subject: [PATCH] setup.py: respect --install-data. Fixes #1575

---
 quodlibet/gdist/appdata.py         | 12 +++---------
 quodlibet/gdist/dbus_services.py   | 14 +++++---------
 quodlibet/gdist/icons.py           | 16 ++++------------
 quodlibet/gdist/man.py             | 11 +++--------
 quodlibet/gdist/po.py              | 11 +++--------
 quodlibet/gdist/search_provider.py | 12 +++---------
 quodlibet/gdist/shortcuts.py       | 11 +++--------
 7 files changed, 24 insertions(+), 63 deletions(-)

diff --git a/quodlibet/gdist/appdata.py b/quodlibet/gdist/appdata.py
index 25f7aef..35f8cee 100644
--- a/quodlibet/gdist/appdata.py
+++ b/quodlibet/gdist/appdata.py
@@ -13,7 +13,6 @@
 import os
 
 from distutils.dep_util import newer
-from distutils.util import change_root
 from distutils.core import Command
 
 
@@ -60,11 +59,10 @@ class install_appdata(Command):
     description = "install .appdata.xml files"
     user_options = []
 
-    prefix = None
+    install_dir = None
     skip_build = None
     appdata = None
     build_base = None
-    root = None
 
     def initialize_options(self):
         self.outfiles = []
@@ -73,8 +71,7 @@ def finalize_options(self):
         self.set_undefined_options('build', ('build_base', 'build_base'))
         self.set_undefined_options(
             'install',
-            ('root', 'root'),
-            ('install_base', 'prefix'),
+            ('install_data', 'install_dir'),
             ('skip_build', 'skip_build'))
 
         self.set_undefined_options(
@@ -87,10 +84,7 @@ def run(self):
         if not self.skip_build:
             self.run_command('build_appdata')
 
-        basepath = os.path.join(self.prefix, 'share', 'appdata')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
-
+        basepath = os.path.join(self.install_dir, 'share', 'appdata')
         srcpath = os.path.join(self.build_base, 'share', 'appdata')
         out = self.mkpath(basepath)
         self.outfiles.extend(out or [])
diff --git a/quodlibet/gdist/dbus_services.py b/quodlibet/gdist/dbus_services.py
index 51c5ed1..d4e216d 100644
--- a/quodlibet/gdist/dbus_services.py
+++ b/quodlibet/gdist/dbus_services.py
@@ -8,7 +8,6 @@
 
 import os
 
-from distutils.util import change_root
 from distutils.core import Command
 
 
@@ -53,11 +52,10 @@ class install_dbus_services(Command):
     user_options = []
 
     def initialize_options(self):
-        self.prefix = None
+        self.install_dir = None
         self.skip_build = None
         self.dbus_services = None
         self.build_base = None
-        self.root = None
         self.outfiles = []
 
     def finalize_options(self):
@@ -67,8 +65,7 @@ def finalize_options(self):
 
         self.set_undefined_options(
             'install',
-            ('root', 'root'),
-            ('install_base', 'prefix'),
+            ('install_data', 'install_dir'),
             ('skip_build', 'skip_build'))
 
         self.set_undefined_options(
@@ -82,9 +79,8 @@ def run(self):
         if not self.skip_build:
             self.run_command('build_dbus_services')
 
-        basepath = os.path.join(self.prefix, 'share', 'dbus-1', 'services')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
+        basepath = os.path.join(
+            self.install_dir, 'share', 'dbus-1', 'services')
         out = self.mkpath(basepath)
         self.outfiles.extend(out or [])
 
@@ -95,7 +91,7 @@ def run(self):
             fullpath = os.path.join(basepath, service_name)
             (out, _) = self.copy_file(fullsrc, fullpath)
             self.outfiles.append(out)
-            _replace(fullpath, "@PREFIX@", self.prefix)
+            _replace(fullpath, "@PREFIX@", self.install_dir)
 
 
 __all__ = ["build_dbus_services", "install_dbus_services"]
diff --git a/quodlibet/gdist/icons.py b/quodlibet/gdist/icons.py
index efc993b..2c4b393 100644
--- a/quodlibet/gdist/icons.py
+++ b/quodlibet/gdist/icons.py
@@ -9,7 +9,6 @@
 import os
 import subprocess
 
-from distutils.util import change_root
 from distutils.core import Command
 
 
@@ -35,25 +34,21 @@ class install_icons(Command):
     """Copy app icons to hicolor/pixmaps and update the global cache"""
 
     user_options = []
-    root = None
-    prefix = None
+    install_dir = None
 
     def initialize_options(self):
         self.outfiles = []
 
     def finalize_options(self):
         self.set_undefined_options('install',
-                                   ('root', 'root'),
-                                   ('install_base', 'prefix'))
+                                   ('install_data', 'install_dir'))
 
     def get_outputs(self):
         return self.outfiles
 
     def run(self):
         # install into hicolor icon theme
-        basepath = os.path.join(self.prefix, 'share', 'icons', 'hicolor')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
+        basepath = os.path.join(self.install_dir, 'share', 'icons', 'hicolor')
 
         local = os.path.join("quodlibet", "images", "hicolor")
 
@@ -71,9 +66,6 @@ def run(self):
         update_icon_cache(basepath)
 
         # install png versions to /usr/share/pixmaps
-        basepath = os.path.join(self.prefix, 'share', 'pixmaps')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
-
+        basepath = os.path.join(self.install_dir, 'share', 'pixmaps')
         out = self.copy_tree(png, basepath)
         self.outfiles.extend(out)
diff --git a/quodlibet/gdist/man.py b/quodlibet/gdist/man.py
index abce7cc..48cd8e7 100644
--- a/quodlibet/gdist/man.py
+++ b/quodlibet/gdist/man.py
@@ -13,7 +13,6 @@
 
 import os
 
-from distutils.util import change_root
 from distutils.core import Command
 
 
@@ -30,20 +29,18 @@ class install_man(Command):
     def initialize_options(self):
         self.man_pages = None
         self.mandir = None
-        self.prefix = None
-        self.root = None
+        self.install_dir = None
         self.outfiles = []
 
     def finalize_options(self):
         self.set_undefined_options(
             'install',
-            ('root', 'root'),
-            ('install_base', 'prefix'),
+            ('install_data', 'install_dir'),
             ('mandir', 'mandir'),
         )
 
         if self.mandir is None:
-            self.mandir = os.path.join(self.prefix, 'share', 'man')
+            self.mandir = os.path.join(self.install_dir, 'share', 'man')
 
         self.man_pages = self.distribution.man_pages
         for man_page in self.man_pages:
@@ -55,8 +52,6 @@ def get_outputs(self):
 
     def run(self):
         basepath = self.mandir
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
         out = self.mkpath(basepath)
         self.outfiles.extend(out or [])
 
diff --git a/quodlibet/gdist/po.py b/quodlibet/gdist/po.py
index 92fbab0..19c9177 100644
--- a/quodlibet/gdist/po.py
+++ b/quodlibet/gdist/po.py
@@ -19,7 +19,6 @@
 import shutil
 
 from distutils.dep_util import newer
-from distutils.util import change_root
 from distutils.spawn import find_executable
 from distutils.core import Command
 
@@ -207,16 +206,14 @@ class install_mo(Command):
     def initialize_options(self):
         self.skip_build = None
         self.build_base = None
-        self.install_base = None
-        self.root = None
+        self.install_dir = None
         self.outfiles = []
 
     def finalize_options(self):
         self.set_undefined_options('build', ('build_base', 'build_base'))
         self.set_undefined_options(
             'install',
-            ('root', 'root'),
-            ('install_base', 'install_base'),
+            ('install_data', 'install_dir'),
             ('skip_build', 'skip_build'))
 
     def get_outputs(self):
@@ -226,9 +223,7 @@ def run(self):
         if not self.skip_build:
             self.run_command('build_mo')
         src = os.path.join(self.build_base, "share", "locale")
-        dest = os.path.join(self.install_base, "share", "locale")
-        if self.root is not None:
-            dest = change_root(self.root, dest)
+        dest = os.path.join(self.install_dir, "share", "locale")
         out = self.copy_tree(src, dest)
         self.outfiles.extend(out)
 
diff --git a/quodlibet/gdist/search_provider.py b/quodlibet/gdist/search_provider.py
index f880dd4..2c41eaa 100644
--- a/quodlibet/gdist/search_provider.py
+++ b/quodlibet/gdist/search_provider.py
@@ -8,15 +8,13 @@
 
 import os
 
-from distutils.util import change_root
 from distutils.core import Command
 
 
 class install_search_provider(Command):
 
     user_options = []
-    root = None
-    prefix = None
+    install_dir = None
     search_provider = None
 
     def initialize_options(self):
@@ -24,8 +22,7 @@ def initialize_options(self):
 
     def finalize_options(self):
         self.set_undefined_options('install',
-                                   ('root', 'root'),
-                                   ('install_base', 'prefix'))
+                                   ('install_data', 'install_dir'))
 
         self.search_provider = self.distribution.search_provider
 
@@ -34,10 +31,7 @@ def get_outputs(self):
 
     def run(self):
         basepath = os.path.join(
-            self.prefix, 'share', 'gnome-shell', 'search-providers')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
-
+            self.install_dir, 'share', 'gnome-shell', 'search-providers')
         out = self.mkpath(basepath)
         self.outfiles.extend(out or [])
         (out, _) = self.copy_file(self.search_provider, basepath)
diff --git a/quodlibet/gdist/shortcuts.py b/quodlibet/gdist/shortcuts.py
index 2a1239f..9ba3391 100644
--- a/quodlibet/gdist/shortcuts.py
+++ b/quodlibet/gdist/shortcuts.py
@@ -9,7 +9,6 @@
 import os
 
 from distutils.dep_util import newer
-from distutils.util import change_root
 from distutils.core import Command
 
 
@@ -62,11 +61,10 @@ class install_shortcuts(Command):
     description = "install .desktop files"
     user_options = []
 
-    prefix = None
+    install_dir = None
     skip_build = None
     shortcuts = None
     build_base = None
-    root = None
 
     def initialize_options(self):
         self.outfiles = []
@@ -75,8 +73,7 @@ def finalize_options(self):
         self.set_undefined_options('build', ('build_base', 'build_base'))
         self.set_undefined_options(
             'install',
-            ('root', 'root'),
-            ('install_base', 'prefix'),
+            ('install_data', 'install_dir'),
             ('skip_build', 'skip_build'))
 
         self.set_undefined_options(
@@ -88,9 +85,7 @@ def get_outputs(self):
     def run(self):
         if not self.skip_build:
             self.run_command('build_shortcuts')
-        basepath = os.path.join(self.prefix, 'share', 'applications')
-        if self.root is not None:
-            basepath = change_root(self.root, basepath)
+        basepath = os.path.join(self.install_dir, 'share', 'applications')
         srcpath = os.path.join(self.build_base, 'share', 'applications')
         out = self.mkpath(basepath)
         self.outfiles.extend(out or [])
