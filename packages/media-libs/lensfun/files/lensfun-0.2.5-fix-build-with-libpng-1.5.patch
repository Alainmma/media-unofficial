Upstream: yes

From c255fedad1fb0f74ab80a6f2fa7f266bbbd90841 Mon Sep 17 00:00:00 2001
From: zap <zap@2a61fa91-e63d-0410-b60c-e65103854af9>
Date: Tue, 25 Jan 2011 18:53:07 +0000
Subject: [PATCH] Patch from Thomas Klausner <tk@giga.or.at> to allow
 compiling with libpng 1.5

git-svn-id: svn://svn.berlios.de/lensfun/trunk@132 2a61fa91-e63d-0410-b60c-e65103854af9
---
 libs/auxfun/image.cpp |   10 +++-------
 1 file changed, 3 insertions(+), 7 deletions(-)

diff --git a/libs/auxfun/image.cpp b/libs/auxfun/image.cpp
index df28e8e..3aac8ca 100644
--- a/libs/auxfun/image.cpp
+++ b/libs/auxfun/image.cpp
@@ -94,7 +94,7 @@ bool Image::LoadPNG ()
 
     png_init_io (png, file);
 
-    if (setjmp (png->jmpbuf))
+    if (setjmp (png_jmpbuf(png)))
         // If we get here, we had a problem reading the file
         goto nomem;
 
@@ -157,7 +157,7 @@ bool Image::LoadPNG ()
     row_pointers = new png_bytep [Height];
 
     if (!row_pointers
-        || setjmp (png->jmpbuf))             // Set a new exception handler
+        || setjmp (png_jmpbuf(png)))             // Set a new exception handler
     {
         delete [] row_pointers;
     nomem:
@@ -214,7 +214,7 @@ bool Image::SavePNG (const char *fName)
     }
 
     /* Catch processing errors */
-    if (setjmp(png->jmpbuf))
+    if (setjmp(png_jmpbuf(png)))
         /* If we get here, we had a problem writing the file */
         goto error2;
 
@@ -273,10 +273,6 @@ bool Image::SavePNG (const char *fName)
     /* It is REQUIRED to call this to finish writing the rest of the file */
     png_write_end (png, info);
 
-    /* if you malloced the palette, free it here */
-    if (info->palette)
-        free (info->palette);
-
     /* clean up after the write, and free any memory allocated */
     png_destroy_write_struct (&png, &info);
 
-- 
1.7.9.6

