# Copyright 2014 Johannes Nixdorf <mixi@exherbo.org>
# Distributed under the terms of the GNU General Public License v2

require github [ pn=oiio user=${PN} tag=Release-${PV} ] cmake [ api=2 ]\
        python [ blacklist=none multibuild=false ]

SUMMARY="A library for reading and writing images."

LICENCES="
    BSD-3
    MIT   [[ note = [ bundled pugixml ] ]]
    GPL-2 [[ note = [ bundled tbb ] ]]
"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS="
    freetype [[ description = [ Support for rendering text on image buffers ] ]]
    gif
    jpeg2000
    raw      [[ description = [ Enable reading RAW image files from digital photo cameras ] ]]
"

DEPENDENCIES="
    build:
        app-text/txt2man
    build+run:
        dev-libs/boost[>=1.42]
        media-libs/ilmbase
        media-libs/jpeg
        media-libs/libpng:=
        media-libs/libwebp
        media-libs/openexr
        media-libs/tiff
        sys-libs/zlib
        virtual/libssl
        freetype? ( media-libs/freetype:2 )
        gif?      ( media-libs/giflib     )
        jpeg2000? ( media-libs/OpenJPEG:0 )
        raw?      ( media-libs/libraw     )
"

BUGS_TO="mixi@exherbo.org"

# tests require e.g. USE_FIELD3D to be enabled
RESTRICT="test"

DEFAULT_SRC_PREPARE_PATCHES+=(
    "${FILES}"/${PNV}-GIF-input-plug-Fix-build-with-giflib-5.1.patch
)

src_configure()
{
    # USE_FIELD3D, USE_OCIO: unwritten
    # TODO: get rid of the bundled pugixml
    args=(
        $(cmake_use FREETYPE)
        $(cmake_use GIF)
        $(cmake_use jpeg2000 OPENJPEG)
        $(cmake_use raw LIBRAW)
        -DDOC_INSTALL_DIR:STRING=share/doc/${PNVR}
        -DLIB_INSTALL_DIR:STRING=${LIBDIR}
        -DOIIO_BUILD_TESTS:BOOL=FALSE
        -DPYLIB_INSTALL_DIR:STRING=$(python_get_sitedir)
        -DPYTHON_VERSION:STRING=$(python_get_abi)
        -DUSE_FIELD3D:BOOL=FALSE
        -DUSE_OCIO:BOOL=FALSE
        -DUSE_OPENCV:BOOL=FALSE
        -DUSE_OPENGL:BOOL=FALSE
        -DUSE_QT:BOOL=FALSE
    )

    ecmake "${args[@]}"
}

